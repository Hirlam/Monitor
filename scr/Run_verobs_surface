#!/bin/ksh

#@ shell           = /bin/ksh
#@ class           = long
#@ job_name        = verobs_surf
#@ output          = $(job_name).$(host).$(jobid).out
#@ error           = $(job_name).$(host).$(jobid).out
#@ environment     = COPY_ALL
#@ notification    = error 
#@ job_cpu_limit   = 3:00:00,2:59:55
#@ wall_clock_limit= 6:00:00,5:29:50
#@ queue 

set -axk

#ulimit -m unlimited
#ulimit -f unlimited
#ulimit -t unlimited
#ulimit -s unlimited

ulimit -m 256000
ulimit -f unlimited
ulimit -t 1800
ulimit -s 921600
ulimit -d 921600

ulimit -a

# Spec

. $HOME/monitor/scr/Env_exp

if [[ $STATIONS == "EHTB" ]] then
 $SCR/Merge_files
fi
if [[ $STATIONS == "HTB" ]] then
 $SCR/Copy_files
fi

set -axk


############ functions
############ functions
############ functions
function experiments {

F=1
EXPNAME=""
  echo '  MODPATH=' >> fort.10
  while [ $F -le $NEXP ] ; do
  echo    \'${MODPATH[$F]}\', >> fort.10
  F=$( expr $F + 1 ) 
done

cat << EOF >> fort.10
  NEXP=$NEXP
  OBSPATH ='$OBSPATH',
  PRINT_READ = 1,
  EXPNAME =
EOF
F=1
while [ $F -le $NEXP ] ; do
  echo \'${EXP[$F]}\', >> fort.10
  F=$( expr $F + 1 ) 
done

}
############ functions
############ functions
############ functions
function end_of_namelist {
cat << EOF >> fort.10
/
EOF
}
############ functions
############ functions
############ functions
function variables {

cat << EOF >> fort.10
 NPARVER = 8,
 FF_IND  = 1,
 DD_IND  = 2,
 PS_IND  = 3,
 TT_IND  = 4,
 RH_IND  = 5,
 QQ_IND  = 6,
 NN_IND  = 7,
 PE_IND  = 8,
 LREJECT_GROSS   = T,
 LPRINT_GROSS    = T,
 TT_LIM = 35.,
 FF_LIM = 40.,
 PS_LIM = 40.,
 PE_LIM = 100.,
EOF


}
############ functions
############ functions
############ functions
function stations {

cat << EOF >> fort.10
 MAXSTN  = 3000,
 STNLIST = 0,
 STNLIST_PLOT =,
 STNLIST_BL=00046,01089,22113,00001,00002,00003,00004,00005,00006,00007,00008,
            00011,00012,00013,00018,00029,00030,00045,                
            02910,02584,02589,02976,02790,02988,02971,02982,02981,02980,02984,
            02496,26115,26214,26128,26226,26218,26313,02489,02493,02487,
            02485,02288,02449,02587,02499
 LPRINT_SUMMARY=F,
EOF
}

#Default list
# STNLIST_BL=00046,01089,22113,
# STNLIST_BL=00046,00051,01089,22113,

# Black list for excluding the sea areas from FMI AROME domain
# STNLIST_BL=00046,01089,22113,00001,00002,00003,00004,00005,00006,00007,00008,
#            00011,00012,00013,00018,00029,00030,00045,                
#            02910,02584,02589,02976,02790,02988,02971,02982,02981,02980,02984,
#            02496,26115,26214,26128,26226,26218,26313,02489,02493,02487,
#            02485,02288,02449,02587,02499
############ functions
############ functions
############ functions

[[ -s $WRK ]] || mkdir -p $WRK
cd $WRK || exit

rm -f *.ps *.png *.dat

#
# Verification by forecast length
#

cat << EOF > fort.10
 &NAMVER
 SDATE           = $SDATE,
 EDATE           = $EDATE,
 STATNAME        ='Surface_LL.dat'
 FCINT           = 24,
 OBINT           = 3,
 NTIMVER         = 8,
 NFCLENGTHS      = 8,
 FCLEN           = 03,06,09,12,15,18,21,24,
 LFCVER          = T,
 DATA_TO_VERIFY  = 1,
 LPLOT_STAT      = T,
 PLOT_BIAS_MAP   = T,
 MAP_SCALE       = $M_SCALE,
 MAP_CENTRE_LATITUDE    = $C_LAT,
 MAP_CENTRE_LONGITUDE   = $C_LON,
 NMAP_HOURS      = 2,
 MAP_HOURS       = 12,24,
 LTIMESERIE_STAT = T,
 LDIFF           = T,
 MAP_BIAS_INTERVAL = -8.,-120.,-3.0,-8.,-25.,-6.,-6.,-8.,-1.,-1.,
                     -4.,-60., -1.0,-4.,-10.,-2.,-4.,-3.,-1.,-1.,
                     -2.,-30., -0.5,-2., -5.,-1.,-2.,-1.,-1.,-1.,
                      0.,  0.,  0. , 0.,  0., 0., 0., 0.,-1.,-1.,
                      2., 30.,  0.5, 2.,  5., 1., 2., 1.,-1.,-1.,
                      4., 60.,  1.0, 4., 10., 2., 4., 3.,-1.,-1.,
                      8.,120.,  3.0, 8., 25., 6., 6., 8.,-1.,-1.,
EOF

experiments
variables
stations
end_of_namelist

cp fort.10 namelist_surf_ll_bias

$BIN/verobs || exit

rm -f fort.10 || true

#
# Verification by time of day (maps only)
#

cat << EOF > fort.10
 &NAMVER
 SDATE           = $SDATE,
 EDATE           = $EDATE,
 STATNAME        ='Surface_HH.dat'
 FCINT           = 24,
 OBINT           = 3,
 NTIMVER         = 8,
 NFCLENGTHS      = 8,
 FCLEN           = 03,06,09,12,15,18,21,24
 LFCVER          = F,
 DATA_TO_VERIFY  = 1,
 LPLOT_STAT      = T,
 LPLOT_FREQ      = T,
 LPLOT_SCAT      = T,
 LDIFF           = T,
 PLOT_BIAS_MAP   = T,
 MAP_SCALE       = $M_SCALE,
 MAP_CENTRE_LATITUDE    = $C_LAT,
 MAP_CENTRE_LONGITUDE   = $C_LON,
 NMAP_HOURS      = 3,
 MAP_HOURS       = 00,12,18,
 SHOW_OBS        = T,
 MAP_BIAS_INTERVAL = -8.,-120.,-3.0,-8.,-25.,-6.,-6.,-8.,-1.,-1.,
                     -4.,-60., -1.0,-4.,-10.,-2.,-4.,-3.,-1.,-1.,
                     -2.,-30., -0.5,-2., -5.,-1.,-2.,-1.,-1.,-1.,
                      0.,  0.,  0. , 0.,  0., 0., 0., 0.,-1.,-1.,
                      2., 30.,  0.5, 2.,  5., 1., 2., 1.,-1.,-1.,
                      4., 60.,  1.0, 4., 10., 2., 4., 3.,-1.,-1.,
                      8.,120.,  3.0, 8., 25., 6., 6., 8.,-1.,-1.,
EOF

experiments
variables
stations
end_of_namelist

cp fort.10 namelist_surf_hh

$BIN/verobs || exit

tar cvf surface_ps.tar *.ps

[[ $WEBCALL == ""  ]] && exit

# Convert to png
$SCR/ps2png 8 1 $NEXP '-resize 75% -rotate 90'

# Include the month information into file name
for F in $( ls *.png ) ; do
 newfile=`echo $F | sed 's/\.png$//'`_${MONTH}.png
 mv $F ${newfile}
done

# Include the station information into file name
if [[ ${PROJ_NAME} == "AROME_00" || ${PROJ_NAME} == "AROME_12"  || ${PROJ_NAME} == "AROME_00_LAND"  ]] then
 for F in $( ls *.png ) ; do
  newfile=${STATIONS}_$F
  mv $F ${newfile}
 done
fi

tar cvf fig.tar *.png

${WEBCALL} -e Surface -f fig.tar
rm -f *.png *.ps
