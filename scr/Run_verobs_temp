#!/bin/ksh

set -ax

#
# Run verobs for surface variables
#

# Spec

. ./Env_exp


cd $SCR || exit
DIR=TEMP
mkdir $WRK/${DIR}_$$ || exit

# Generate namelists
for F in $TEMPPAR ; do
   ./Build_namelist.pl -t ${DIR} -p $F > $WRK/${DIR}_$$/namelist_$F || exit
done

cd $WRK/${DIR}_$$ || exit

# Run verobs for the different parameters
for F in $TEMPPAR ; do
   cp namelist_$F fort.10
   $BIN/verobs || exit
done

[[ $WEBCALL == ""  ]] && exit

# Quality control information
echo '<pre>'   > quality.html
cat fort.48   >> quality.html
echo '</pre>' >> quality.html

#
# Generate browser friendly graphics
#

mkdir vert 
if [ $OUTPUT_TYPE -eq 1 ] ; then
   mv l*.ps vert
   for F in $( ls -1 *.ps ) ; do
      FF=$( basename $F .ps )
      convert -resize 75% -rotate 90 $FF.ps $FF.png
   done
   tar cvf temp.tar *.png *.ps
elif [ $OUTPUT_TYPE -eq 2 ] ; then
   mv l*.png vert
   tar cvf temp.tar *.png
elif [ $OUTPUT_TYPE -eq 3 ] ; then
   mv l*.jpg vert
   tar cvf temp.tar *.jpg
fi

rm -f *.jpg *.ps *.png

#Vertical
cp $SCR/style.xsl .
if [ $OUTPUT_TYPE -eq 1 ] ; then
   rm -f *.ps
   mv vert/*.ps .
   for F in $( ls -1 *.ps ) ; do
      FF=$( basename $F .ps )
      convert -resize 75% $FF.ps $FF.png
   done
   tar cvf vert.tar *.png *.xml style.xsl *.html *.ps
elif [ $OUTPUT_TYPE -eq 2 ] ; then
   rm -f *.png
   mv vert/*.png .
   tar cvf vert.tar *.png *.xml style.xsl *.html
elif [ $OUTPUT_TYPE -eq 3 ] ; then
   rm -f *.jpg
   mv vert/*.jpg .
   tar cvf vert.tar *.jpg *.xml style.xsl *.html
fi 

rmdir vert

# Send data to WebgraF
$WEBCALL -e Temp -f temp.tar
$WEBCALL -e Prof_Temp -f vert.tar

# Clean
cd $SCR
rm -rf $WRK/${DIR}_$$ || exit

# Create WebgraF interface
./Create_ver_js.pl TEMP
