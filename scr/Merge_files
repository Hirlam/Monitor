#!/bin/ksh

function itoc {
   if (( $1 >= 0 && $1 < 10 ))
   then
      echo 0$1
   elif (( $1 >= 10 && $1 < 100 ))
   then
      echo $1
   else
      echo error
   fi
}


# Function for simple arithmetic with real numbers
function calc {

    awk "BEGIN { print $@ }"
}

. $SCR/Env_exp

set +x

#**************************************************
# First merge the EWGLAM and HTB observation files
#**************************************************

cd $OBSPATH || exit
if [[ ${STATIONS} == "EHTB" ]] then
 MM=`perl -e "printf('%2.2i', '$MONTH')"`
 rm -f vobs????${MM}*
fi

DTG=${SDATE}00
DTGEND=${EDATE}00
DTGEND=`newdate $DTGEND +24`

while [ $DTG -le ${DTGEND} ]; do

 ln -sf ../EWGLAM/vobs${DTG} ewglam.txt 
 ln -sf ../HTB/vhtb${DTG} htb.txt

 head -2 ewglam.txt > head1
 head -2 htb.txt > head2
 
# Read headers from the first obs-file
 II=1
 while read Line
 do
 
   if [[ $II == 1 ]] then
     SURF1=`echo $Line|awk '{print $1}'`
     TEMP1=`echo $Line|awk '{print $2}'`
   fi 
  
   if [[ $II == 2 ]] then
     LEVS1=`echo $Line|awk '{print $1}'`
   fi 

   let II+=1
 done < head1

# Read headers from the second obs-file
 II=1
 while read Line
 do
 
   if [[ $II == 1 ]] then
     SURF2=`echo $Line|awk '{print $1}'`
     TEMP2=`echo $Line|awk '{print $2}'`
   fi 
  
   if [[ $II == 2 ]] then
     LEVS2=`echo $Line|awk '{print $1}'`
   fi 

   let II+=1
 done < head2

 NEWSURF=0
 NEWTEMP=0
 NEWLEVS=0

 let NEWSURF+=$SURF1+$SURF2
 let NEWTEMP+=$TEMP1+$TEMP2
 let NEWLEVS+=$LEVS1

 echo "Creating: vobs"$DTG

 # create a new header for the new file
 perl -e "printf(\"%7d%6d\n\",'$NEWSURF','$NEWTEMP')" > vobs${DTG}
 perl -e "printf(\"%7d\n\",'$NEWLEVS')" >> vobs${DTG}

 # Surface and temp data from the original files
 BODY1="$(calc \($LEVS1+1\)*$TEMP1+$SURF1)"
 BODY2="$(calc \($LEVS2+1\)*$TEMP2+$SURF2)"
 TEMPLINES1="$(calc \($LEVS1+1\)*$TEMP1)"
 TEMPLINES2="$(calc \($LEVS2+1\)*$TEMP2)"

 tail -${BODY1} ewglam.txt | head -${SURF1} >> vobs${DTG}
 tail -${BODY2} htb.txt | head -${SURF2} >> vobs${DTG}
 tail -${TEMPLINES1} ewglam.txt >> vobs${DTG}
 tail -${TEMPLINES2} htb.txt >> vobs${DTG}

 DTG=`newdate $DTG +3`
done

rm -f head* ewglam.txt htb.txt

#**************************************************
# Secondly, merge the EWGLAM and HTB fldextr files
#**************************************************

#set -x

cd ${MODPATH[1]} || exit
if [[ ${STATIONS} == "EHTB" ]] then
 MM=`perl -e "printf('%2.2i', '$MONTH')"`
 rm -f vfld???20??${MM}*
fi

DTG=${SDATE}00
DTGEND=${EDATE}00

while [ $DTG -le ${DTGEND} ]; do

 FEXP=1
 while [ $FEXP -le $NEXP ]; do

   if [[ ${EXP[$FEXP]} == "ARO" ]] then
     LL=3
   else
     LL=0
   fi

   while [ $LL -le 24 ]; do
     
     ln -sf ../../EWGLAM/00/vfld${EXP[$FEXP]}${DTG}$(itoc $LL) ewglam.txt
     ln -sf ../../HTB/00/vfld${EXP[$FEXP]}htb${DTG}$(itoc $LL) htb.txt

     head -2 ewglam.txt > head1
     head -2 htb.txt > head2

# Read headers from the first fldextr-file
     II=1
     while read Line
     do
 
       if [[ $II == 1 ]] then
         SURF1=`echo $Line|awk '{print $1}'`
         TEMP1=`echo $Line|awk '{print $2}'`
       fi 
  
       if [[ $II == 2 ]] then
         LEVS1=`echo $Line|awk '{print $1}'`
       fi 

       let II+=1
     done < head1

# Read headers from the second fldextr-file
     II=1
     while read Line
     do
 
       if [[ $II == 1 ]] then
         SURF2=`echo $Line|awk '{print $1}'`
         TEMP2=`echo $Line|awk '{print $2}'`
       fi 
  
       if [[ $II == 2 ]] then
         LEVS2=`echo $Line|awk '{print $1}'`
       fi 

       let II+=1
     done < head2

     NEWSURF=0
     NEWTEMP=0
     NEWLEVS=0

     let NEWSURF+=$SURF1+$SURF2
     let NEWTEMP+=$TEMP1+$TEMP2
     let NEWLEVS+=$LEVS1

     echo "Creating: vfld${EXP[$FEXP]}"$DTG$(itoc $LL)

 # create a new header for the new file
     perl -e "printf(\"%7d%6d\n\",'$NEWSURF','$NEWTEMP')" > vfld${EXP[$FEXP]}${DTG}$(itoc $LL)
     perl -e "printf(\"%7d\n\",'$NEWLEVS')" >> vfld${EXP[$FEXP]}${DTG}$(itoc $LL)

 # Surface and temp data from the original files
     BODY1="$(calc \($LEVS1+1\)*$TEMP1+$SURF1)"
     BODY2="$(calc \($LEVS2+1\)*$TEMP2+$SURF2)"
     TEMPLINES1="$(calc \($LEVS1+1\)*$TEMP1)"
     TEMPLINES2="$(calc \($LEVS2+1\)*$TEMP2)"

     tail -${BODY1} ewglam.txt | head -${SURF1} >> vfld${EXP[$FEXP]}${DTG}$(itoc $LL)
     tail -${BODY2} htb.txt | head -${SURF2} >> vfld${EXP[$FEXP]}${DTG}$(itoc $LL)
     tail -${TEMPLINES1} ewglam.txt >> vfld${EXP[$FEXP]}${DTG}$(itoc $LL)
     tail -${TEMPLINES2} htb.txt >> vfld${EXP[$FEXP]}${DTG}$(itoc $LL)


     let LL+=3
   done
   let FEXP+=1
 done

 DTG=`newdate $DTG +24`
done

rm -f head* ewglam.txt htb.txt

exit